// Prisma Schema for Order Service - MySQL Database
// Based on original Mongoose models: order.model.js, cart.model.js, user.model.js
// Only 3 tables: Order, Cart, User (matching the 3 models)
// Nested arrays/objects stored as JSON columns (like MongoDB)

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "mysql"
  url      = env("DATABASE_URL")
}

// Order Model - matches order.model.js exactly
// Only ONE table for Order (all nested data in JSON)
model Order {
  id                  String   @id @default(uuid())
  userId              String   @db.VarChar(255) // Original: String, required
  vendorId            String   @db.VarChar(255) // Original: String, required
  logisticsId         String?  @db.VarChar(255) // Original: String
  
  // Items array stored as JSON (matching MongoDB structure)
  items               Json     @default("[]") // Original: [{productId, productName, productImage, itemId, category, price, quantity}]
  
  authenticationCode  String?  @db.VarChar(255) // Original: String
  deliveryTimeline    String?  @db.VarChar(255) // Original: String
  
  // Shipping address stored as JSON (matching MongoDB structure)
  shippingAddress     Json?    // Original: {street, city, state, postalCode, country, phone}
  
  customerName        String?  @db.VarChar(255) // Original: String
  totalAmount         Decimal  @db.Decimal(10, 2) // Original: Number, required
  discountAmount      Decimal  @default(0) @db.Decimal(10, 2) // Original: Number, default: 0
  deliveryCharges     Decimal  @default(0) @db.Decimal(10, 2) // Original: Number, default: 0
  
  couponCode          String?  @db.VarChar(255) // Original: String
  
  paymentMethod       String   @default("COD") @db.VarChar(50) // Original: enum, default: "COD"
  paymentStatus       String   @default("PENDING") @db.VarChar(50) // Original: enum, default: "PENDING"
  transactionId       String?  @db.VarChar(255) // Original: String
  
  purchaseDate        DateTime @default(now()) // Original: Date, default: Date.now
  expectedDeliveryDate DateTime? // Original: Date
  actualDeliveryDate   DateTime? // Original: Date
  
  status              String   @default("inprogress") @db.VarChar(50) // Original: enum, default: "inprogress"
  deliveryStatus      String   @default("Pending") @db.VarChar(50) // Original: enum, default: "Pending"
  orderProgress       String   @default("Awaiting Confirmation") @db.VarChar(255) // Original: String, default: "Awaiting Confirmation"
  
  notes               String?  @db.Text // Original: String
  vendorNotes         String?  @db.Text // Original: String
  
  // Status history stored as JSON array (matching MongoDB structure)
  statusHistory       Json     @default("[]") // Original: [{status, updatedAt, updatedBy}]
  
  platform            String   @default("Web") @db.VarChar(50) // Original: enum, default: "Web"
  
  isDeleted           Boolean  @default(false) // Original: Boolean, default: false
  isReturnRequested   Boolean  @default(false) // Original: Boolean, default: false
  
  // Return request stored as JSON (matching MongoDB structure)
  returnRequest       Json?    // Original: {isRequested, reason, requestedAt, status, refundAmount, processedBy}
  
  createdAt           DateTime @default(now()) @map("created_at") // Original: timestamps: true
  updatedAt           DateTime @updatedAt @map("updated_at") // Original: timestamps: true

  @@map("orders")
  @@index([userId])
  @@index([vendorId])
  @@index([logisticsId])
  @@index([status])
  @@index([paymentStatus])
}

// Cart Model - matches cart.model.js exactly
// Only ONE table for Cart (items array in JSON)
model Cart {
  id          String   @id @default(uuid())
  userId      String   @unique @db.VarChar(255) // Original: String, required, unique
  items       Json     @default("[]") // Original: [{productId, vendorId, productName, productImage, price, quantity, variantIndex}]
  totalPrice  Decimal  @default(0) @db.Decimal(10, 2) // Original: Number, default: 0
  createdAt   DateTime @default(now()) @map("created_at") // Original: timestamps: true
  updatedAt   DateTime @updatedAt @map("updated_at") // Original: timestamps: true

  @@map("carts")
  @@index([userId])
}

// User Model - matches user.model.js exactly
// Only ONE table for User (all nested data in JSON)
model User {
  id                  String   @id @default(uuid())
  email               String   @db.VarChar(255) // Original: String, required, lowercase, trim
  phone               String?  @db.VarChar(50) // Original: String
  password            String?  @db.VarChar(255) // Original: String
  vendorId            String?  @unique @db.VarChar(255) // Original: String, unique for trivestore
  clientId            String?  @unique @db.VarChar(255) // Original: String, unique for trivemart
  platform            String   @db.VarChar(50) // Original: enum ["trivemart", "trivestore", "triveexpress"], required
  googleId            String?  @db.VarChar(255) // Original: String
  facebookId          String?  @db.VarChar(255) // Original: String
  name                String?  @db.VarChar(255) // Original: String
  role                String   @default("user") @db.VarChar(50) // Original: String, default: "user", enum: ["user", "admin"]
  firstName           String?  @db.VarChar(255) // Original: String
  lastName            String?  @db.VarChar(255) // Original: String
  
  // Addresses array stored as JSON (matching MongoDB structure)
  addresses           Json     @default("[]") // Original: [{country, state, city, localGovernment, address, postalCode, isDefault}]
  
  profileImage        String?  @db.VarChar(500) // Original: String
  
  // Extra details stored as JSON array (matching MongoDB structure)
  extraDetails        Json     @default("[]") // Original: [{label, value}]
  
  // Email confirmation stored as JSON (matching MongoDB structure)
  emailConfirmation   Json?    // Original: {token, expiresAt}
  
  isEmailConfirmed    Boolean  @default(false) // Original: Boolean, default: false
  createdAt           DateTime @default(now()) @map("created_at") // Original: timestamps: true
  updatedAt           DateTime @updatedAt @map("updated_at") // Original: timestamps: true

  @@map("users")
  @@index([email])
  @@index([platform])
  @@index([vendorId])
  @@index([clientId])
}

